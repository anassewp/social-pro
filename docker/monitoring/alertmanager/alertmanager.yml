# AlertManager Configuration for Social Pro
# Comprehensive alerting and notification setup

global:
  # Global SMTP configuration
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@social-pro.app'
  smtp_auth_username: 'alerts@social-pro.app'
  smtp_auth_password: 'your_email_app_password'
  smtp_require_tls: true

  # Slack configuration
  slack_api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'

# Templates for notifications
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# Notification routing
route:
  group_by: ['alertname', 'service', 'environment']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h
  receiver: 'default'
  
  routes:
    # Critical alerts - immediate notification
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 10s
      repeat_interval: 5m
    
    # Warning alerts - less urgent
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 2m
      repeat_interval: 1h
    
    # Application-specific alerts
    - match:
        service: social-pro
        component: application
      receiver: 'app-team'
    
    # Database alerts
    - match:
        service: social-pro
        component: database
      receiver: 'db-team'
    
    # Security alerts
    - match:
        service: social-pro
        component: security
      receiver: 'security-team'
    
    # Infrastructure alerts
    - match:
        service: monitoring
      receiver: 'ops-team'

# Inhibit rules to prevent alert spam
inhibit_rules:
  # Inhibit warning alerts if critical alert is firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'instance']

  # Inhibit application alerts if application is down
  - source_match:
      alertname: 'ApplicationDown'
    target_match:
      service: 'social-pro'
      component: 'application'
    equal: ['instance']

# Receivers (notification destinations)
receivers:
  # Default receiver
  - name: 'default'
    email_configs:
      - to: 'team@social-pro.app'
        subject: '[Social Pro] Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Service: {{ .Labels.service }}
          Instance: {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # Critical alerts - multiple channels
  - name: 'critical-alerts'
    # Slack notification
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts-critical'
        title: 'üö® {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          *Instance:* {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          *Runbook:* <{{ .Annotations.runbook_url }}|Click here>
          {{ end }}
          {{ end }}
        send_resolved: true
        color: 'danger'
    
    # Email notification
    email_configs:
      - to: 'oncall@social-pro.app'
        subject: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          üö® **CRITICAL ALERT** üö®
          
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Service: {{ .Labels.service }}
          Component: {{ .Labels.component }}
          Instance: {{ .Labels.instance }}
          Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
          {{ if .Annotations.runbook_url }}
          
          üìñ **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}
    
    # PagerDuty notification (if configured)
    pagerduty_configs:
      - service_key: 'your_pagerduty_integration_key'
        description: 'Social Pro Critical Alert: {{ .GroupLabels.alertname }}'
        details:
          severity: '{{ .CommonLabels.severity }}'
          service: '{{ .CommonLabels.service }}'
          component: '{{ .CommonLabels.component }}'
          instance: '{{ .CommonLabels.instance }}'

  # Warning alerts
  - name: 'warning-alerts'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts-warning'
        title: '‚ö†Ô∏è {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          ‚ö†Ô∏è *Warning:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          *Instance:* {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          *Runbook:* <{{ .Annotations.runbook_url }}|Click here>
          {{ end }}
          {{ end }}
        send_resolved: true
        color: 'warning'

  # Application team alerts
  - name: 'app-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#app-team'
        title: 'üì± App Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          üì± *Application Alert*
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Component: {{ .Labels.component }}
          Instance: {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          üìñ <{{ .Annotations.runbook_url }}|Runbook>
          {{ end }}
          {{ end }}
        send_resolved: true

  # Database team alerts
  - name: 'db-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#db-team'
        title: 'üóÑÔ∏è Database Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          üóÑÔ∏è *Database Alert*
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          üìñ <{{ .Annotations.runbook_url }}|Runbook>
          {{ end }}
          {{ end }}
        send_resolved: true

  # Security team alerts
  - name: 'security-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#security'
        title: 'üîí Security Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          üîí *Security Alert*
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          üìñ <{{ .Annotations.runbook_url }}|Runbook>
          {{ end }}
          {{ end }}
        send_resolved: true
        color: 'danger'
    
    # Email notification for security team
    email_configs:
      - to: 'security@social-pro.app'
        subject: 'üîí Security Alert: {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          üîí **SECURITY ALERT**
          
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Started: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
          {{ if .Annotations.runbook_url }}
          
          üìñ **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # Operations team alerts
  - name: 'ops-team'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#ops'
        title: '‚öôÔ∏è Ops Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          ‚öôÔ∏è *Infrastructure Alert*
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .Labels.service }}
          Component: {{ .Labels.component }}
          Instance: {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          üìñ <{{ .Annotations.runbook_url }}|Runbook>
          {{ end }}
          {{ end }}
        send_resolved: true

  # On-call rotation (PagerDuty integration)
  - name: 'oncall'
    pagerduty_configs:
      - service_key: 'your_pagerduty_service_key'
        description: 'Social Pro On-Call Alert: {{ .GroupLabels.alertname }}'
        details:
          source: 'Social Pro Monitoring'
          severity: '{{ .CommonLabels.severity }}'
          component: '{{ .CommonLabels.component }}'
          group: '{{ .CommonLabels.service }}'
          class: 'infrastructure'

  # Telegram notifications
  - name: 'telegram'
    telegram_configs:
      - bot_token: 'YOUR_TELEGRAM_BOT_TOKEN'
        chat_id: 'YOUR_TELEGRAM_CHAT_ID'
        message: |
          {{ range .Alerts }}
          üö® {{ .Annotations.summary }}
          
          Description: {{ .Annotations.description }}
          Severity: {{ .Labels.severity }}
          Service: {{ .Labels.service }}
          Instance: {{ .Labels.instance }}
          {{ if .Annotations.runbook_url }}
          Runbook: {{ .Annotations.runbook_url }}
          {{ end }}
          {{ end }}

  # Discord notifications
  - name: 'discord'
    discord_configs:
      - webhook_url: 'YOUR_DISCORD_WEBHOOK'
        title: 'Social Pro Alert: {{ .GroupLabels.alertname }}'
        message: |
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          
          {{ .Annotations.description }}
          
          Severity: {{ .Labels.severity }}
          Service: {{ .Labels.service }}
          Component: {{ .Labels.component }}
          
          {{ if .Annotations.runbook_url }}
          [Runbook]({{ .Annotations.runbook_url }})
          {{ end }}
          {{ end }}

# Inhibition rules to prevent alert flooding
inhibit_rules:
  # Suppress warning alerts when critical alert is firing for same service
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'instance']

  # Suppress component alerts when application is completely down
  - source_match:
      alertname: 'ApplicationDown'
    target_match:
      service: 'social-pro'
    equal: ['instance']

  # Suppress specific alerts when service is down
  - source_match:
      alertname: 'ServiceDown'
    target_match:
      service: 'social-pro'
    equal: ['service']

# Mute rules for maintenance windows
mute_time_intervals:
  # Weekly maintenance window
  - name: 'maintenance'
    time_intervals:
      - times:
          - start_time: '02:00'
            end_time: '04:00'
        weekdays: ['sunday']
        timezone: 'UTC'

# Silence rules for temporary alert suppression
time_intervals:
  # Business hours (reduce noise during non-business hours)
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        timezone: 'UTC'

# Alert acknowledgments
# Enable ack tracking for better alert management
alertmanager_config:
  retention: 120h  # Keep alerts for 5 days
  resolve_timeout: 5m  # Resolve alerts after 5 minutes of healthy state
